# 从神策小程序SDK中学习小程序数据收集

Description: 从神策小程序SDK中学习小程序数据收集
Public: Yes
Published: 2022/02/09
Tags: 小程序

### 背景

业务需求，需要收集用户在小程序端的特定行为（页面浏览时长，点击行为等）。

### 初始实现

刚开始是根据业务需求，在小程序端特定页面或者特定的事件上添加函数处理，重复代码多，每次修改很麻烦。

### 神策的实现

在同事的帮助下看了神策收集数据的方式，将小程序特定行为数据的收集写成可配置的，大大减少了重复代码，提高了代码可维护性。

### 神策SDK中的简单实现

小程序根据组件级别可以分为App、Page和Component。

1. App

监听App的显示和隐藏比较简单，小程序有提供专门的API

```jsx
// 小程序显示
wx.onAppShow(function (para) {
  // 获取小程序启动时的参数。与 App.onLaunch 的回调参数一致
  const option = wx.getLaunchOptionsSync();
  // 处理逻辑
});
// 小程序隐藏
wx.onAppHide(function () {
    // 处理逻辑
});
```

1. Page

在app.js中，App.onLaunch 中重写下Page，以记录进入每个页面的浏览时长为例：

```jsx
let pageEnterTime;
App({
  onLaunch: () => {
    let oldPage = Page
    Page = function (obj) {
      const oldOnLoad = obj.onLoad
      // 进入页面
      obj.onLoad = function (options) {
        pageEnterTime = Date.now();
        oldOnLoad && oldOnLoad.call(this, options);
      }
      const oldOnHide = obj.onHide
      // 页面跳转
      obj.onHide = function (options) {
        pageStayTime = Date.now() - pageEnterTime;
        // 记录时间
        oldOnHide && oldOnHide.call(this, options);
      }

      const oldOnUnload = obj.onUnload
      // 返回按钮
      obj.onUnload = function (options) {
        pageStayTime = Date.now() - pageEnterTime
        // 记录时间
        oldOnUnload && oldOnUnload.call(this, options);
      }
      oldPage(obj);
    }
  }
})
```

其他的点击事件或者页面事件类似，都可以写成这种可配置的方式

1. Component

Component和Page类似，在App.onLaunch 中重写下Component，然后处理Component事件或者点击事件

### 参考

[sa-sdk-miniprogram](https://github.com/sensorsdata/sa-sdk-miniprogram/blob/master/product/sensorsdata.full.js)