---
title: 给现有的项目中添加一个文档工具
description: 给现有的项目中添加一个文档工具
date: 2022/07/28
updated: 2022/07/28
tags:
  - 工具
  - typescript
categories:
  - typescript
---

### 背景

前端项目开发到一定程度，各种抽象出来的组件就变得难以识别和维护，这时候就急需一个文档工具，理论上集成一下[docz](https://www.docz.site/)或者[dumi](https://d.umijs.org/zh-CN)即可，但是这两个项目由于依赖冲入，配置冲突，资源加载等原因集成进去已有的项目是非常困难的，各种报错。

### 造轮子思路

在现有的背景下自己根据需求实现一个是比较理想的，以umi项目为例，只需要将`src/components/myComponent` 目录下的mdx文件转换为react组件即可，然后新开一个路由将转换的react组件全部加载进来即可。

### 转换组件

首先需要转换和解析组件：

```bash
npm i xdm remark-frontmatter remark-mdx-frontmatter @mdx-js/react
```

### 批量转换脚本

约定：每个组件中的文档文件命名为`doc.mdx`，转换后的文档文件命名为`doc.js`,这样将每个组件下的文档文件进行批量转换：

```jsx
// genDoc.js
import fs, { writeFileSync, readFileSync } from 'fs';
import path from 'path';
import remarkFrontmatter from 'remark-frontmatter';
import remarkMdxFrontmatter from 'remark-mdx-frontmatter';
import { compileSync } from 'xdm';

const comPath = path.resolve(process.cwd(), 'src/components');
const comDirs = fs.readdirSync(comPath);

comDirs.forEach(v => {
  const docMdxPath = path.resolve(comPath, v, 'doc.mdx');
  if (fs.existsSync(docMdxPath)) {
    const { value } = compileSync(readFileSync(docMdxPath), {
      jsx: true,
      providerImportSource: '@mdx-js/react',
      remarkPlugins: [remarkFrontmatter, remarkMdxFrontmatter],
    });
    writeFileSync(path.resolve(comPath, v, 'doc.js'), value)
  }
})
```

### 文档路由切换

.umirc.ts文件修改

```jsx
const docRoutes = [{ path: '/doc', component: '@/pages/doc' }]
...
routes: process.env.mode === 'doc' ? docRoutes : routes,
```

package.json文件添加doc命令

```jsx
"doc": "node genDoc && cross-env mode=doc umi dev",
```

这样执行`npm run doc` 时，可以快速仅启动文档路由

### 路由文件

加入动态生成路由文件后就基本完成任务了，现在只需要关注编写mdx文档了。

```javascript
// genDoc.js
// ...
// 动态生成路由文件
const getTemplate = (docPaths) =>  `
import { MDXProvider } from '@mdx-js/react';
import { useState } from 'react';
${docPaths.map(v => `import ${v}Doc, { title as ${v}Title } from '@/components/${v}/doc.js';`).join('\\n')}

const Doc = () => {
  const titles = [${docPaths.map(v => `${v}Title`).join(',')}];
  const contents = [${docPaths.map(v => `${v}Doc`).join(',')}];
  const [cur, setCur] = useState(0)

  return (
    <div>
      {titles.map((v, i) => <div onClick={() => setCur(i)}>{v}</div>)}
      {/* @ts-ignore */}
      <MDXProvider>
        {contents[cur]()}
      </MDXProvider>
    </div>
  );
};
export default Doc;
`
const template = getTemplate(docComDirs);

const docPath = path.resolve(process.cwd(), 'src/pages/doc/index.tsx');

writeFileSync(docPath, template)
```

### 待完善

由于文档文件和动态生成路由文件是在项目启动的时候做的，所以本地开发不能实时的添加文档文件，这个需要优化下。
